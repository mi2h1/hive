# ボードゲーム「POLYFORM」Web版 仕様書

## 1. ゲーム概要

**コンセプト**: パズルピースを集めて配置し、パズルカードを完成させる拡大再生産パズルゲーム

| 項目 | 内容 |
|------|------|
| プレイ人数 | 2〜4人 |
| プレイ時間 | 30〜60分 |
| 対象年齢 | 10歳〜 |

---

## 2. コンポーネント

### 2.1 ピース（9種類）

ピースはレベル1〜4の4段階に分かれ、レベルが高いほどマス数が多い。

| レベル | タイプ | 名称 | マス数 | 色 | 形状（相対座標） |
|--------|--------|------|--------|-----|-----------------|
| 1 | dot | 1マス | 1 | 黄色 (yellow-300) | `[[0,0]]` |
| 2 | i2 | I字(2) | 2 | 緑 (green-400) | `[[0,0],[1,0]]` |
| 3 | i3 | I字(3) | 3 | 青 (blue-500) | `[[0,0],[1,0],[2,0]]` |
| 3 | v3 | V字 | 3 | オレンジ (amber-400) | `[[0,0],[0,1],[1,1]]` |
| 4 | i4 | I字(4) | 4 | 紫 (purple-400) | `[[0,0],[1,0],[2,0],[3,0]]` |
| 4 | l4 | L字(4) | 4 | 水色 (cyan-400) | `[[0,0],[1,0],[2,0],[2,1]]` |
| 4 | t4 | T字 | 4 | ピンク (pink-400) | `[[0,0],[1,0],[2,0],[1,1]]` |
| 4 | s4 | S字 | 4 | オレンジ (orange-400) | `[[0,0],[1,0],[1,1],[2,1]]` |
| 4 | o4 | 正方形 | 4 | 赤 (red-500) | `[[0,0],[1,0],[0,1],[1,1]]` |

#### ピースの初期ストック数

| タイプ | 枚数 |
|--------|------|
| dot | 15枚 |
| i2 | 12枚 |
| i3, v3 | 各6枚 |
| i4, l4, t4, s4, o4 | 各6枚 |

**合計**: 69枚

### 2.2 パズルカード

パズルカードは白と黒の2種類。

| 種類 | 枚数 | 特徴 | ポイント範囲 |
|------|------|------|-------------|
| 白カード | 32枚 | 比較的シンプルな形状 | 0〜2pt |
| 黒カード | 20枚 | 複雑な形状、高ポイント | 3〜5pt |

**合計**: 52枚

各カードには以下の要素がある：
- **ポイント**: 完成時に獲得できる得点
- **報酬ピース**: 完成時に獲得できるピース（全カードに1つ付与）
- **形状**: 5x5グリッド内で埋めるべきマスのパターン

#### 白カード報酬分布

| 報酬ピース | 枚数 |
|-----------|------|
| dot | 1枚 |
| i2 | 7枚 |
| i3 | 5枚 |
| v3 | 5枚 |
| i4 | 3枚 |
| l4 | 3枚 |
| t4 | 3枚 |
| s4 | 3枚 |
| o4 | 2枚 |

#### 黒カード報酬分布

| 報酬ピース | 枚数 |
|-----------|------|
| dot | 6枚 |
| i2 | 3枚 |
| i3 | 3枚 |
| v3 | 3枚 |
| i4 | 1枚 |
| l4 | 1枚 |
| t4 | 1枚 |
| s4 | 1枚 |
| o4 | 1枚 |

---

## 3. ゲームルール

### 3.1 セットアップ

1. 白パズルデッキ（20枚）をシャッフル
2. 黒パズルデッキをプレイヤー人数に応じて準備
   - 2人: 20枚からランダムに12枚を選択
   - 3人: 20枚からランダムに14枚を選択
   - 4人: 20枚からランダムに16枚を選択
3. 場に白パズル4枚、黒パズル4枚を公開
4. 各プレイヤーに初期ピース（dot × 2）を配布
5. スタートプレイヤーをランダムに決定

### 3.2 ターン進行

各プレイヤーは自分のターンに **3アクション** を実行できる。

#### アクション一覧

| アクション | 説明 | 消費 | 備考 |
|------------|------|------|------|
| パズル取得 | 場のパズルカードを1枚獲得 | 1アクション | 最大4枚まで所持可能 |
| ピース獲得 | レベル1ピース（dot）を1個獲得 | 1アクション | ストックから取得 |
| ピース配置 | 手持ちピースを作業中パズルに配置 | 1アクション | - |
| レベルアップ | ピースを上位レベルに変換 | 1アクション | レベル3以上は形状選択可能 |
| レベルダウン | ピースを下位レベルに分解 | 1アクション | レベル3以上は分解後の形状選択可能 |
| リサイクル | 場のカード4枚を山札に戻し、新しい4枚を公開 | 1アクション | 山札4枚以上必要 |
| マスターアクション | 全ての作業中パズルに1個ずつピース配置可能 | 1アクション | 1ターン1回のみ |

#### アクションの詳細

**パズル取得**
- 場の白パズルまたは黒パズルから1枚選んで獲得
- 取得後、山札から1枚補充される
- 作業中パズルは最大4枚まで

**ピース配置**
- 選択したピースを回転・反転して配置位置を決める
- パズルの形状内に収まる位置にのみ配置可能
- 既存のピースと重ならないこと
- 配置後に「確定」または「キャンセル」を選択
  - 確定: アクションを消費してピースを配置
  - キャンセル: ピースを手元に戻してアクション選択に戻る

**レベル変更**
- レベルアップ: 小さいピースを消費して大きいピースを獲得
- レベルダウン: 大きいピースを消費して小さいピースを獲得
- 変換レート: レベル差分のマス数が必要

**マスターアクション**
- 1ターンに1回のみ使用可能
- 使用すると、所持している全ての作業中パズルに対して1個ずつピースを配置できる
- 配置は任意（一部のパズルだけに配置してもよい）

### 3.3 ピースの操作

#### 回転・反転
- ピースは90度単位で回転可能（0°, 90°, 180°, 270°）
- 左右反転も可能
- 配置時に任意の向きで配置できる

#### レベル変更の詳細

**レベルアップ**
| 変換元 | 変換先 | 必要マス数 |
|--------|--------|-----------|
| dot × 2 | i2 | 2マス |
| i2 + dot または dot × 3 | i3 または v3（選択可） | 3マス |
| i3 + dot, v3 + dot, i2 × 2, i2 + dot × 2, dot × 4 | i4, l4, t4, s4, o4（選択可） | 4マス |

**レベルダウン**
| 変換元 | 変換先 |
|--------|--------|
| i2 | dot × 2 |
| i3 または v3 | i2 + dot または dot × 3 |
| i4, l4, t4, s4, o4 | i3 + dot, v3 + dot, i2 × 2, i2 + dot × 2, dot × 4 |

### 3.4 パズル完成

パズルカードのすべてのマスをピースで埋めると完成となる。

完成時：
1. カードに記載されたポイントを即座に獲得
2. 報酬ピースを獲得
3. パズルカードは完成エリアへ移動（作業中スロットが空く）
4. 完成した白/黒カードの枚数がカウントされる

### 3.5 ゲーム終了条件

以下のいずれかの条件を満たすと**最終ラウンド**に突入：

| 条件 | 説明 |
|------|------|
| 白カード5枚完成 | いずれかのプレイヤーが白カードを5枚完成 |
| 黒カード3枚完成 | いずれかのプレイヤーが黒カードを3枚完成 |
| 山札枯渇 | 白または黒の山札が尽きた |

最終ラウンドでは、トリガーを引いたプレイヤーの**手前**まで全員がプレイして通常ラウンド終了。

### 3.6 仕上げフェーズ

通常ラウンド終了後、**仕上げフェーズ**に移行。

- 各プレイヤーは作業中パズルに手持ちピースを配置できる
- ただし、配置した数だけ**ペナルティ**（-1点/個）が発生
- 全員が「仕上げ完了」を選択すると結果発表へ

### 3.7 最終スコア計算

```
最終スコア = 完成パズルのポイント合計
           - 仕上げペナルティ
           - 未完成パズルのポイント合計（マイナス）
```

| 項目 | 計算 |
|------|------|
| 完成パズルポイント | 各パズルのポイントを合計 |
| 仕上げペナルティ | 仕上げフェーズで配置した数 × -1 |
| 未完成ペナルティ | 未完成パズルのポイントをマイナス |

### 3.8 勝利条件

最終得点が最も高いプレイヤーの勝利。

---

## 4. ゲームフェーズ

| フェーズ | 説明 |
|----------|------|
| waiting | ロビーで待機中 |
| playing | 通常ゲーム中 |
| finalRound | 最終ラウンド中（ゲーム終了条件達成後） |
| finishing | 仕上げフェーズ |
| ended | ゲーム終了・結果表示 |

---

## 5. 実装済み機能

### 5.1 画面構成

#### ① ロビー画面

- ルーム作成（4桁のルームコード生成）
- ルーム参加（コード入力）
- プレイヤー一覧表示（ホストにはクラウンアイコン）
- ゲーム設定（スコア公開/非公開）
- ゲーム開始ボタン（ホストのみ、2人以上で有効）
- ゲーム開始時のトランジションアニメーション

#### ② ゲーム画面

| エリア | 説明 |
|--------|------|
| ヘッダー | ロゴ、プレイヤー名、スコア、ターン表示、操作ボタン |
| 他プレイヤー欄 | 全プレイヤーの状態（所持パズル、完成枚数、ピース数） |
| インフォボード | ターン情報、アクション選択、残りアクション数、アナウンス表示 |
| 場（白パズル） | 白パズル4枚＋山札残り枚数 |
| 場（黒パズル） | 黒パズル4枚＋山札残り枚数 |
| ピース一覧 | 全ピース種類のリファレンス表示 |
| 作業中パズル | 作業中パズル（最大4枚）とピース配置UI |
| 手持ちピース | 所持ピース一覧、選択・操作UI |

#### ③ 結果画面

- プレイヤーごとの完成パズル表示（フリップアニメーション）
- 未完成パズルの表示（赤ハイライト＋「未完成」バッジ）
- 順位バッジ表示（1位〜4位）
- 最終スコア内訳表示（完成ポイント、ペナルティ）
- ホスト用ボタン：「退出」「もう一度プレイ」
- 非ホスト用：「ホストの選択を待っています...」メッセージ＋「退出」ボタン

#### ④ プレイヤー不在画面

- ホスト退出時に表示
- 「プレイヤーが見つかりません」メッセージ
- 「ロビーに戻る」ボタン

### 5.2 インタラクション

- **ドラッグ＆ドロップ**: ピースをパズルへ配置
- **配置の確定/キャンセル**: ピース配置後に確定またはキャンセルを選択
- **回転ボタン**: 選択中ピースを90度回転
- **反転ボタン**: 選択中ピースを左右反転
- **UP/DOWNボタン**: レベル変更（形状選択モーダル付き）
- **ホバープレビュー**: 配置可能位置のハイライト表示
- **ゴースト表示**: ドラッグ中のピース位置プレビュー

### 5.3 UI/UX機能

- レスポンシブデザイン（7段階のカードサイズ対応）
- 1280px以下でレイアウト自動切り替え（縦積み）
- アクションモード別のハイライト表示
- カード取得アニメーション
- リサイクルアニメーション（退出→入場）
- パズル完成アニメーション
- 結果画面のパズルフリップアニメーション
- アナウンス表示（2秒後自動消去）
- 最終ラウンド表示（赤い「FINAL ROUND」バッジ）

### 5.4 通信・同期

| 機能 | 実装方式 |
|------|------|
| リアルタイム同期 | Firebase Realtime Database |
| ルーム管理 | 4桁コード方式 |
| ホスト権限継承 | プレゼンスシステムで自動継承 |
| 自動削除 | 全員切断時にルーム削除 |

---

## 6. ディレクトリ構成

### 本番版（polyform）

```
src/games/polyform/
├── PolyformGame.tsx          # メインコンポーネント
├── components/
│   ├── Lobby.tsx             # ロビー画面
│   ├── GamePlayPhase.tsx     # ゲーム画面（通常・最終・仕上げ・結果）
│   ├── GameStartTransition.tsx # ゲーム開始トランジション
│   ├── PuzzleCardDisplay.tsx # パズルカード表示
│   ├── DroppablePuzzleCard.tsx # ドロップ可能パズルカード
│   ├── PieceDisplay.tsx      # ピース表示
│   └── DraggablePiece.tsx    # ドラッグ可能ピース
├── hooks/
│   └── useRoom.ts            # ルーム管理フック
├── data/
│   ├── pieces.ts             # ピース定義（9種類）
│   └── puzzles.ts            # パズルカード定義（52枚）
└── types/
    └── game.ts               # 型定義
```

### 開発版（polyform-dev）

```
src/games/polyform-dev/
└── ... （本番と同構造 + デバッグ機能）
```

---

## 7. ゲーム設定

### 7.1 実装済みオプション

| 機能 | 説明 | 選択肢 |
|------|------|--------|
| スコア表示 | 他プレイヤーのスコア表示 | 公開（常時表示）/ 非公開（終了時まで非表示） |

### 7.2 未実装オプション

| 機能 | 説明 |
|------|------|
| ゲーム終了条件変更 | 完成枚数の調整 |
| 初期ピース変更 | 開始時のピース構成を変更 |
| ターンタイマー | 制限時間付きターン |

---

## 8. 開発版（polyform-dev）

開発版では以下の追加機能が利用可能：

| 機能 | 説明 |
|------|------|
| プレイヤー切り替え | 任意のプレイヤーを操作可能（プルダウン） |
| テストプレイヤー追加 | 1人でもテストプレイ可能 |
| 1人開始 | 1人でもゲーム開始可能 |
| 即終了ボタン | ゲームを即座に仕上げフェーズにする |
| ターン終了ボタン | 現在のターンを強制終了 |

---

## 9. レスポンシブ対応

### ブレークポイント

| 画面幅 | カードサイズ | ピースサイズ |
|--------|-------------|-------------|
| 1850px〜 | xxl | lg |
| 1650px〜 | xl | md |
| 1500px〜 | lg | md |
| 1300px〜 | md | md |
| 1100px〜 | sm | sm |
| 900px〜 | xs | sm |
| 〜900px | xxs | xs |

### レイアウト切り替え

| 画面幅 | レイアウト |
|--------|----------|
| 1280px以上 | 2カラム（左: プレイヤー情報、右: メインエリア） |
| 1280px未満 | 1カラム（縦積み）、ピース一覧非表示 |

---

## 10. 型定義

### Player（プレイヤー状態）

```typescript
interface Player {
  id: string;
  name: string;
  pieces: PieceInstance[];       // 手持ちピース
  workingPuzzles: WorkingPuzzle[]; // 作業中パズル（最大4枚）
  completedPuzzles: CompletedPuzzle[]; // 完成パズル
  completedPuzzleIds: string[];  // 完成パズルID一覧
  completedWhite: number;        // 完成した白カード枚数
  completedBlack: number;        // 完成した黒カード枚数
  score: number;                 // 現在のスコア
  remainingActions: number;      // 残りアクション数
  usedMasterAction: boolean;     // マスターアクション使用済みフラグ
  finishingDone: boolean;        // 仕上げ完了フラグ
  finishingPenalty: number;      // 仕上げペナルティ
}
```

### GameState（ゲーム状態）

```typescript
interface GameState {
  phase: GamePhase;
  players: Player[];
  playerOrder: string[];         // プレイ順
  currentPlayerIndex: number;
  hostId: string;

  // 場の状態
  whitePuzzleDeck: string[];     // 白パズル山札
  blackPuzzleDeck: string[];     // 黒パズル山札
  whitePuzzleMarket: string[];   // 場の白パズル（4枚）
  blackPuzzleMarket: string[];   // 場の黒パズル（4枚）

  // ピースストック
  pieceStock: Record<PieceType, number>;

  // ゲーム終了関連
  finalRound: boolean;
  finalRoundStartPlayer: string | null;

  // 設定
  settings: GameSettings;

  // タイムスタンプ
  createdAt: number;
  updatedAt: number;
}
```

---

## 11. 今後の拡張案

- [ ] 観戦モード
- [ ] AI対戦
- [ ] 戦績記録
- [ ] チュートリアルモード
- [ ] サウンドエフェクト
- [ ] アチーブメント機能
- [ ] カスタムパズル作成機能
