# ボードゲーム「デスペラード」Web版 仕様書

## 1. ゲーム概要

**コンセプト**: サイコロ2個を振って出目の強さを競うダイスバトルゲーム。最弱の出目を出したプレイヤーがライフを失い、最後まで生き残ったプレイヤーが勝利する。

| 項目 | 内容 |
|------|------|
| プレイ人数 | 2〜8人 |
| プレイ時間 | 10〜20分 |
| 対象年齢 | 8歳〜 |

---

## 2. 出目のランキング

### 2.1 出目の強さ（強い順）

| 順位 | 出目 | 種類 | 内部値 |
|------|------|------|--------|
| 1位 | 1-2 | デスペラード | 100 |
| 2位 | 6-6 | ゾロ目 | 96 |
| 3位 | 5-5 | ゾロ目 | 95 |
| 4位 | 4-4 | ゾロ目 | 94 |
| 5位 | 3-3 | ゾロ目 | 93 |
| 6位 | 2-2 | ゾロ目 | 92 |
| 7位 | 1-1 | ゾロ目 | 91 |
| 8位〜 | バラ目 | 合計値順 | 12〜4 |

### 2.2 バラ目の詳細（合計値順）

| 合計値 | 組み合わせ例 |
|--------|------------|
| 12 | 6-6 はゾロ目扱い |
| 11 | 6-5, 5-6 |
| 10 | 6-4, 5-5 はゾロ目, 4-6 |
| ... | ... |
| 4 | 3-1, 1-3（最弱） |
| 3 | 2-1, 1-2 はデスペラード扱い |

**注意**: 1-2 の組み合わせは「デスペラード」として最強扱い

---

## 3. ゲームルール

### 3.1 セットアップ

1. 各プレイヤーにライフ5を付与
2. ターン順をランダムに決定
3. ゲーム開始

### 3.2 ラウンド進行

```
┌─────────────────────────────────────┐
│           ラウンド開始               │
│  全プレイヤーのダイス・振り直しリセット│
└───────────────┬─────────────────────┘
                ↓
┌─────────────────────────────────────┐
│      ターン順にダイスを振る          │
│  （自分のターンで「振る」ボタン）     │
└───────────────┬─────────────────────┘
                ↓
┌─────────────────────────────────────┐
│       振り直しまたはキープを選択      │
│  - 振り直し: 残り回数があれば可能     │
│  - キープ: 現在の出目で確定           │
└───────────────┬─────────────────────┘
                ↓
┌─────────────────────────────────────┐
│     全員がキープするまでターン進行    │
└───────────────┬─────────────────────┘
                ↓
┌─────────────────────────────────────┐
│           結果判定                   │
│    最弱の出目を特定                  │
└───────────────┬─────────────────────┘
                ↓
    ┌───────────┴───────────┐
    ↓                       ↓
┌─────────────────┐   ┌─────────────────┐
│ デスペラードなし │   │ デスペラードあり │
│   ペナルティ: 1  │   │   ペナルティ: 2  │
└────────┬────────┘   └────────┬────────┘
         └──────────┬──────────┘
                    ↓
┌─────────────────────────────────────┐
│    最弱プレイヤーがライフを失う      │
│    （同点の場合は全員にペナルティ）  │
└───────────────┬─────────────────────┘
                ↓
┌─────────────────────────────────────┐
│    ライフ0のプレイヤーは脱落         │
│    生存者1人になったら終了           │
└─────────────────────────────────────┘
```

### 3.3 振り直しルール

| 項目 | 内容 |
|------|------|
| 初期振り直し回数 | 2回 |
| 最大ロール回数 | 3回（1回目 + 振り直し2回） |
| リセットタイミング | 各ラウンド開始時 |

- 振った後、「振り直す」か「キープ」を選択
- 振り直しは残り回数がある限り何度でも可能
- キープを選ぶと出目が確定し、次のプレイヤーへ
- 振り直し回数が0になったらキープのみ可能

#### 振り直し回数のカウント

```
1回目のロール: 振り直し残り2回（消費しない）
  ↓ 「振り直す」を選択
2回目のロール: 振り直し残り1回（1回消費）
  ↓ 「振り直す」を選択
3回目のロール: 振り直し残り0回（1回消費）
  ↓ 「キープ」のみ可能
```

**注意**: 最初のロールでは振り直し回数を消費しない

### 3.4 ペナルティルール

| 条件 | ペナルティ |
|------|-----------|
| 通常 | ライフ-1 |
| デスペラード発動中 | ライフ-2 |

- 誰かがデスペラードを出すと、そのラウンドのペナルティが2倍になる
- 最弱が同点の場合、該当者全員がペナルティを受ける

### 3.5 勝敗条件

- ライフが0になったプレイヤーは脱落
- 最後まで生き残ったプレイヤーが勝利
- 複数人が同時に脱落し、生存者がいなくなった場合は引き分け

---

## 4. 実装済み機能

### 4.1 画面構成

#### ① ロビー画面（ルーム作成/参加）

- ルーム作成（4桁のルームコード生成）
- ルーム参加（コード入力）
- 遊び方モーダル（?アイコン）
- ゲーム選択に戻るボタン

#### ② ルーム待機画面

| 要素 | 説明 |
|------|------|
| ロゴ | Desperado ロゴ表示 |
| ルームコード | タップでコピー可能 |
| 参加者一覧 | ホストに王冠アイコン |
| ゲーム開始ボタン | ホストのみ、2人以上で有効 |
| 退出ボタン | ルームから退出 |

#### ③ ゲーム画面

| 要素 | 説明 |
|------|------|
| ヘッダー | ロゴ + ラウンド数（左）、退出ボタン（右） |
| プレイヤー一覧 | ライフ、出目、ターン状態を表示 |
| ダイスフィールド | 3Dダイス表示（緑のフェルト風） |
| ダイスを振るボタン | 自分のターン時のみ表示 |
| 結果表示 | ラウンド終了時に敗者と次ラウンドボタン |

#### ④ ゲーム終了画面

- 勝者表示（トロフィーアイコン）
- 最終結果（順位、ライフ状況）
- 「もう一度遊ぶ」ボタン
- 退出ボタン

### 4.2 ダイス表示

#### dddice 連携

| 項目 | 内容 |
|------|------|
| 3Dレンダリング | dddice-js SDK 使用 |
| 同期方式 | dddice ルームで全員にアニメーション同期 |
| テーマ | カスタムテーマ（untitled-dice-mkhmye02） |
| ダイスサイズ | 2.5（デフォルトより大きめ） |
| カメラ操作 | 無効化（タッチで視点変更しない） |

#### ダイスフィールドデザイン

- 緑のフェルト風グラデーション背景
- 内側シャドウで立体感
- 角丸の長方形

### 4.3 UI/UX機能

| 機能 | 説明 |
|------|------|
| ダイスアイコン | Lucide の Dice1〜6 を使用 |
| ライフ表示 | ハートアイコン（塗り/空で残量表示） |
| ターン表示 | 現在のプレイヤーを強調表示 |
| 出目表示 | 種類に応じた色分け（デスペラード=金、ゾロ目=紫、バラ目=白） |
| デスペラード警告 | 発動時に画面上部でアニメーション表示 |

### 4.4 通信・同期

| 機能 | 実装方式 |
|------|------|
| リアルタイム同期 | Firebase Realtime Database |
| ルーム管理 | 4桁コード方式 |
| ホスト権限継承 | プレゼンスシステムで自動継承 |
| 自動削除 | 全員切断時にルーム削除 |
| ダイスアニメーション | dddice ルームで同期 |
| dddice ルーム管理 | Firebase と連携、退出時に自動削除 |

---

## 5. ディレクトリ構成

```
src/games/desperado/
├── DesperadoGame.tsx       # メインコンポーネント
├── components/
│   ├── Lobby.tsx           # ロビー画面
│   ├── GamePlayPhase.tsx   # ゲーム画面
│   ├── ResultScreen.tsx    # ゲーム終了画面
│   ├── DiceRoller.tsx      # ダイス表示（dddice連携）
│   └── RulesModal.tsx      # 遊び方モーダル
├── hooks/
│   └── useRoom.ts          # ルーム管理フック
├── lib/
│   └── dice.ts             # ダイス計算ロジック
└── types/
    └── game.ts             # 型定義
```

---

## 6. 型定義

### 6.1 ゲームフェーズ

```typescript
type GamePhase = 'waiting' | 'rolling' | 'result' | 'game_end';
```

| フェーズ | 説明 |
|----------|------|
| waiting | ロビーで待機中 |
| rolling | ダイスを振るフェーズ |
| result | ラウンド結果表示 |
| game_end | ゲーム終了 |

### 6.2 ダイス出目

```typescript
interface DiceResult {
  die1: number; // 1-6
  die2: number; // 1-6
}

type RollType = 'desperado' | 'doubles' | 'normal';

interface RollRank {
  type: RollType;
  value: number; // 比較用の数値
}
```

### 6.3 プレイヤー

```typescript
interface Player {
  id: string;
  name: string;
  lives: number;
  currentRoll: DiceResult | null;
  hasRolled: boolean;
  isEliminated: boolean;
  rerollsRemaining: number; // 残り振り直し回数（初期値2）
}
```

### 6.4 ゲーム状態

```typescript
interface GameState {
  phase: GamePhase;
  players: Player[];
  currentRound: number;
  desperadoRolledThisRound: boolean;
  turnOrder: string[];
  currentTurnPlayerId: string | null;
  lastLoser: string | null;
  winnerId: string | null;
  rollingPlayerId: string | null;
  dddiceRoomSlug: string | null;
}
```

---

## 7. dddice 連携詳細

### 7.1 初期化フロー

1. SDK初期化（APIキー、canvas設定）
2. カメラコントロール無効化
3. テーマプリロード
4. ホストがdddiceルーム作成 → slugをFirebaseに保存
5. 他プレイヤーがslugを取得してルームに参加
6. WebSocket接続で全員同期

### 7.2 ロールフロー

1. プレイヤーが「振る」ボタンをクリック
2. `rollingPlayerId` をセット → 全員の画面でダイスクリア
3. dddice API でロール実行
4. dddice サーバーで出目決定
5. 全クライアントにロール結果とアニメーションが配信
6. ロールしたプレイヤーのみが `onRollComplete` で結果を Firebase に保存

### 7.3 ルーム削除タイミング

- ホストがルームを退出
- 最後のプレイヤーが退出
- プレゼンス監視で全員オフライン
- 古いルームのクリーンアップ（24時間経過）

---

## 8. 今後の拡張案

- 開発版（desperado-dev）の追加
- 観戦モード
- ライフ数のカスタマイズ
- サドンデスルール（残り2人で特殊ルール）
- 効果音・BGM
- 戦績記録
- リプレイ機能
