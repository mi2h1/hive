# 進捗・作業ログ

最終更新: 2026-02-23

## リポジトリ情報

| 項目 | 内容 |
|------|------|
| リポジトリ | https://github.com/mi2h1/hive |
| 公開URL | https://mi2h1.github.io/hive/ |
| ブランチ運用 | main のみ（直接プッシュ） |
| デプロイ | GitHub Actions → GitHub Pages |

## ディレクトリ構成

→ `docs/project-context.md` を参照

---

## 速雀 開発フェーズ

### Phase 1: 卓3Dビジュアル — 完了 (2026-02-21〜22)
- 3D卓の構築（フェルト面・木枠・中抜き板・台形タイル）
- 牌モデル（RoundedBoxGeometry + MeshPhysicalMaterial + bumpMap彫り込み）
- 中央情報パネル（外枠・溝底・内パネル・ターンランプ・局数/残牌/ドラ表示）
- 風パネル + プレイヤー情報（風名・名前・得点LED表示）
- フォトリアル質感（フェルトsheen・木枠clearcoat・漆塗りパネル）
- ポストプロセッシング（SSAO + Bloom）
- 4家の牌配置（自家=表向き傾斜、他家=直立裏面、河=寝かせ表向き）
- GameScreen / ローディングオーバーレイ / テストページ

### Phase 2: ゲームループUI接続 — 完了 (2026-02-22)
- **ゲームロジック（lib/、全て実装済み）:**
  - `tile-deck.ts` — デッキ生成、シャッフル、配牌、ツモ
  - `win-detector.ts` — 2面子判定（バックトラッキング）
  - `furiten.ts` — 待ち牌計算、フリテン判定、ロン可否
  - `scoring.ts` — 点数計算（役満含む）、ScoreResult型
  - `game-flow.ts` — 局初期化、ツモ/打牌/ロン精算、流局、次手番、勝敗判定
- **UI接続:**
  - GameState に `roundResult` / `timeBank` / `timeLimitSeconds` を追加
  - TileModel にクリック・ホバーイベント対応
  - TableScene に手牌クリック打牌・ツモ/ロンボタン(3Dメッシュ)・ホバー浮き上がり
  - GameScreen にゲームループ処理（自動ツモ・打牌・ロンチェック・持ち時間管理）
  - SokuJongGame に round_result 画面（手牌・点数内訳・持ち点一覧）、finished 画面（ランキング）
  - Lobby に持ち時間モード選択（5分 / 無制限）
- **Bot自動プレイ:**
  - テストプレイヤー（`test-` prefix）の手番を自動処理（ツモ・ツモ切り・ロン判定）
  - 800ms ディレイで視覚的にわかりやすく
  - 1人＋botでテスト対戦可能
- **テンパイ待ち牌表示:**
  - 手牌5枚時に `findWaitingTiles()` で和了可能な牌種を計算
  - 手牌の上に2Dオーバーレイで表示（黒背景パネル + 牌画像）
- **手牌・ツモ牌のギャップ:**
  - 手牌6枚時、最後の1枚（ツモ牌）を少し右にずらして表示
- **画面チラつき修正:**
  - 全牌テクスチャ(20種)をモジュールレベルでプリロード
- **その他修正:**
  - 流局時に `roundResult.type='draw'` をセット
  - ゲーム開始時にスコアをリセット（再戦対応）
  - ロビー帰還時に timeBank をクリア

### Phase 3: マルチプレイヤー — 完了
- Firebase Realtime Database によるリアルタイム同期（useRoom）
- ルーム作成・参加・退出・プレゼンス管理
- ロン判定・フリテン判定
- 頭ハネ（打牌者の次の席順から優先）

### UI改善 (2026-02-22〜23)
- **河の配置修正:** 2段目以降を手前方向に配置（奥→手前に修正）
- **待ち牌表示の改善:**
  - 3Dシーン内表示 → 2Dオーバーレイに変更（複数枚表示バグ修正）
  - 黒背景パネル + 「待ち」ラベル + 牌画像で表示
  - useMemo依存を配列参照→内容ベースに変更（Firebase更新時の再計算漏れ修正）
- **和了結果画面のモーダルオーバーレイ化:**
  - 画面遷移方式 → 3Dシーン上にモーダルオーバーレイで表示
  - 2ステップ構成: 和了結果（手牌+点数内訳）→ 点数移動
  - 手牌を2D牌画像（アイボリー背景+テクスチャ画像）で表示
  - RoundResult に prevScores を追加して点数移動差分を表示
  - 流局時はステップ1のみ（点数移動なし）
- **ロビー2カラムレイアウト:**
  - 招待リンクの下を2カラムに分割（左: 参加者一覧、右: 持ち時間設定）
- **仕様書更新:** soku-jong-spec.md を v2.0 に改訂

### Phase 4: 切断・再接続対応 — 未着手
- 切断プレイヤーの自動ツモ切り（3秒タイムアウト）
- ロン見逃し自動処理
- ホスト引き継ぎ（ホスト切断時）

### Phase 5: 仕上げ — 未着手
- 打牌アニメーション（手牌→河へスライド＆倒れ）
- ツモアニメーション（山札→手牌へスライドイン）
- 和了演出（スポットライト）
- モバイル対応（タッチ操作・レスポンシブ）

---

## 速雀 ゲームフロー

```
turnPhase='draw' → processDraw() → turnPhase='discard'（canTsumoならツモボタン表示）
  → 手牌クリック → processDiscard() → turnPhase='ron_check'
  → checkRonCandidates() → ロン可能者にロンボタン / なければ次手番
  → getNextTurnPlayerId() → turnPhase='draw' に戻る
```

---

## 速雀 主要ファイル

| ファイル | 役割 |
|----------|------|
| `types/game.ts` | 型定義（Tile, Player, GameState, RoundResult, GameSettings） |
| `lib/tile-deck.ts` | デッキ生成・シャッフル・配牌・ツモ |
| `lib/win-detector.ts` | 2面子判定（バックトラッキング） |
| `lib/furiten.ts` | 待ち牌計算・フリテン判定・ロン可否 |
| `lib/scoring.ts` | 点数計算（基本点+ボーナス+役満） |
| `lib/game-flow.ts` | 局初期化・ツモ/打牌/ロン精算・流局・次手番・勝敗判定 |
| `hooks/useRoom.ts` | Firebase連携（ルーム管理・プレゼンス・状態同期） |
| `components/Lobby.tsx` | ロビー画面（ルーム作成/参加・2カラム設定） |
| `components/GameScreen.tsx` | ゲーム操作ハブ（ループ・持ち時間・bot・結果モーダル・待ち牌パネル） |
| `components/TableScene.tsx` | 3Dシーン（卓・牌配置・ボタン） |
| `components/TileModel.tsx` | 牌3Dモデル（テクスチャ・マテリアル・クリック/ホバー） |
| `SokuJongGame.tsx` | ゲーム全体管理（フェーズ分岐・結果画面） |

---

## 完了したタスク（速雀以外）

### Phase 1: 基盤構築・ゲーム実装
- ポータル画面（名前入力・ゲーム選択）
- 6種のゲーム実装（AoA, もじはんと, ジャッカル, POLYFORM, SPARK, デスペラード）
- Firebase Realtime Database による部屋管理
- GitHub Pages デプロイパイプライン

### 直近の作業
- ジャッカルにハテナカードのフリップ演出を追加
- ジャッカルのプレイヤーカードを多角形配置に変更
- 全員切断時に部屋が残り続ける問題を修正
- DEV版ゲーム3種を削除し、SPARK部屋監視を追加
- 未使用の型定義を削除
- CLAUDE.md をリモートから削除し、gitignore に追加
- ドキュメント構成を整理

### 2026-02-19
- もじはんとに「お題選択式」モードを追加
  - ロビーでホストが「お題ランダム」「お題選択式」を切替可能
  - 選択式: 担当プレイヤーが6候補から選択 or 自由記述でお題を決定
  - 担当はラウンドごとにローテーション（参加順）
  - お題チェンジ投票は選択式モード時に topic_selection フェーズへ戻す
- ロビーUIの改善（参加者+お題モードの2カラム配置）
- 開発規約・進捗ログドキュメントの新規作成
