# もじはんと 仕様書

## ゲーム概要

「もじはんと」は2〜5人で遊ぶひらがな当てバトルゲーム。
お題に沿った言葉をひらがなで設定し、他のプレイヤーに当てられないように守りながら、相手の言葉を当てるゲーム。

## 基本ルール

### ゲームの流れ

1. **ルーム作成/参加** - ホストがルームを作成し、他プレイヤーが参加
2. **お題決定** - モードに応じてお題が決まる（後述「お題モード」参照）
3. **言葉入力** - 各プレイヤーがお題に沿った言葉をひらがなで入力（2〜7文字）
4. **バトル開始** - 順番にひらがな1文字を宣言して攻撃
5. **ヒット判定** - 宣言した文字が含まれるプレイヤーは該当文字が公開
6. **脱落判定** - 全文字が公開されたプレイヤーは脱落
7. **勝利判定** - 最後まで残ったプレイヤーが勝利

### 攻撃ルール

- 自分の言葉もヒット対象になる
- 他プレイヤーにヒットしたら連続攻撃（1回まで）
- 自分だけヒットした場合は連続攻撃なし
- 誰にもヒットしなければターン終了

### 特殊ルール

#### 同時脱落の勝利条件
2人残りの状態で、両者とも未公開が1文字ずつ、かつ同じ文字だった場合：
- 宣言したプレイヤー（攻撃者）が勝利

### お題モード

ロビーでホストが以下のモードを選択する：

#### お題ランダム（デフォルト）
- ゲーム開始時にお題リストからランダムに選出

#### お題選択式
- 担当プレイヤーが6つの候補から選択、または自由記述でお題を入力
- 担当はラウンドごとにローテーション（参加順：1回戦→Player1、2回戦→Player2…）
- 候補は「別の候補」ボタンで何度でも入れ替え可能

### お題チェンジ

- 言葉入力中、全員が「お題チェンジ」に投票すると新しいお題に変更
- 投票は言葉確定後でも可能
- 変更時は全員の入力がリセットされる
- 回数制限なし
- お題選択式モード時はお題選択フェーズに戻る（同じ担当者が再選択）

### 言葉の修正

- 言葉入力後、「修正する」ボタンで再編集可能
- 他のプレイヤーがまだ入力中の場合のみ修正可能
- 全員が入力完了するとゲームが開始され修正不可

## 文字の正規化

入力された言葉は以下のルールで正規化される：

### 濁点・半濁点の除去
- が→か、ぎ→き、ぐ→く、げ→け、ご→こ
- ざ→さ、じ→し、ず→す、ぜ→せ、ぞ→そ
- だ→た、ぢ→ち、づ→つ、で→て、ど→と
- ば→は、び→ひ、ぶ→ふ、べ→へ、ぼ→ほ
- ぱ→は、ぴ→ひ、ぷ→ふ、ぺ→へ、ぽ→ほ

### 小文字の大文字変換
- ぁ→あ、ぃ→い、ぅ→う、ぇ→え、ぉ→お
- ゃ→や、ゅ→ゆ、ょ→よ
- っ→つ
- ゎ→わ

### 長音の変換
- ー（長音符）は直前の母音に変換

## 文字パネル

攻撃に使用する50音パネル（47文字）：

```
わ ら や ま は な た さ か あ
を り    み ひ に ち し き い
ん る ゆ む ふ ぬ つ す く う
   れ    め へ ね て せ け え
ー ろ よ も ほ の と そ こ お
```

- 使用済みの文字はグレーアウト
- 長音「ー」も選択可能

## ゲームフェーズ

| フェーズ | 説明 |
|---------|------|
| `waiting` | ロビー待機中（プレイヤー参加待ち） |
| `topic_selection` | お題選択中（選択式モード時のみ） |
| `word_input` | 言葉入力中 |
| `playing` | ゲーム進行中（攻撃フェーズ） |
| `game_end` | ゲーム終了（結果表示） |

## 結果画面

### 順位表示（メダルカラー）
- **1位**: 金色（yellow-500）
- **2位**: 銀色（slate-400）
- **3位**: 銅色（amber-600）
- **4位以降**: グレー

### 言葉の公開
結果画面では全員の言葉が全文字公開される：
- **ピンク背景**: ゲーム中に当てられた文字
- **緑（emerald）背景**: 最後まで公開されなかった文字

## データ構造

### Player（プレイヤー状態）
```typescript
interface Player {
  id: string;
  name: string;
  wordLength: number;        // 言葉の文字数
  normalizedWord: string;    // 正規化後の言葉
  revealedPositions: boolean[];  // 各位置の公開状態
  revealedCharacters: string[];  // 公開された文字
  isEliminated: boolean;     // 脱落フラグ
  isReady: boolean;          // 入力完了フラグ
  eliminatedAt?: number;     // 脱落順（1から）
}
```

### GameState（ゲーム状態）
```typescript
interface GameState {
  phase: GamePhase;
  settings: GameSettings;
  currentTopic: string;
  players: Player[];
  currentTurnPlayerId: string | null;
  turnOrder: string[];
  usedCharacters: string[];
  attackHistory: AttackResult[];
  lastAttackHadHit: boolean;
  winnerId: string | null;
  currentAttack?: CurrentAttack;
  topicChangeVotes: string[];
  roundNumber: number;           // ラウンド番号（お題担当ローテーション用）
  topicSelectorId: string | null; // お題選択式での担当プレイヤーID
}
```

## お題一覧

全88種類のお題がランダムで選出される：

### 物・もの系
- 飲みもの、のりもの、文房具、食べもの、音の出るもの
- 学校にあるもの、いま部屋にあるもの、コンビニにあるもの
- 公園にあるもの、最近買ったもの、家にあるもの
- キッチン用品、電子機器、災害時に必要なもの、常に持っていくもの

### 生き物系
- 動物、架空の生き物、虫、生き物、植物

### 食べ物系
- 野菜、くだもの、お菓子、お弁当のおかず、めん類
- 中華料理、パンといえば、寿司ネタ

### 場所・季節系
- 行きたい場所、最近出かけた場所、この近所にあるもの
- 日本の観光地、海外の観光地、海といえば、山といえば
- 春といえば、夏といえば、秋といえば、冬といえば
- お正月、夏休み、年間行事

### 名前・タイトル系
- 職業、名称、有名人の名前、バンド・グループの名前
- 会社の名前、チェーン店の名前
- 本のタイトル、ゲームのタイトル、マンガのタイトル
- キャラクター

### その他
- スポーツ、楽器、武器の名前、技の名前、あいさつ、宇宙といえば

### 形容詞系
- おいしいもの、なつかしいもの、大好きなもの、嫌いなもの
- あまいもの、にがいもの、あたたかいもの、つめたいもの
- 赤いもの、丸いもの、長いもの、大きいもの、やわらかいもの
- とぶもの、まわるもの、禁止されてるもの

### 自分系
- 好きなタイプ、自分を動物に例えると、自分を一言で表すと
- 自分の一番大切なもの、ドキドキするもの、気になるもの
- 苦手だった人の名前、いま食べたいもの

## 画面構成

### 1. ロビー画面（Lobby.tsx）
- ルーム作成/参加
- プレイヤー一覧表示（左カラム）
- お題モード選択（右カラム、ホストのみ変更可）
- ゲーム開始ボタン（ホストのみ）

### 1.5. お題選択画面（TopicSelectionPhase.tsx）
- 担当プレイヤー: 6候補を3x2グリッド表示 + 自由記述入力
- 他プレイヤー: 「Xさんがお題を選んでいます...」の待機画面

### 2. 言葉入力画面（WordInputPhase.tsx）
- お題表示
- ひらがな入力フォーム
- 正規化プレビュー表示
- プレイヤー準備状況
- お題チェンジ投票ボタン
- 「修正する」ボタン（入力完了後）

### 3. ゲーム進行画面（GamePlayPhase.tsx）
- ひらがなボード（攻撃文字選択）
- プレイヤーの言葉表示（PlayerWordDisplay.tsx）
- 攻撃履歴
- 現在のターン表示

### 4. 結果画面（ResultScreen.tsx）
- 勝者表示（トロフィーアイコン + テキスト横並び）
- 全プレイヤーの言葉公開（メダルカラー付き）
- ゲーム統計（使用文字数、攻撃回数）
- もう一度遊ぶボタン

## Firebase構造

```
moji-hunt-rooms/
└── {roomCode}/
    ├── hostId: string
    ├── topicMode: 'random' | 'selection'
    ├── createdAt: number
    └── gameState: GameState
```

## 部屋の自動削除

- Firebase `onDisconnect` を使用したプレゼンスシステム
- ホストが切断すると別のプレイヤーにホスト権限を継承
- 全プレイヤーが切断すると部屋を自動削除
- テストプレイヤー（ID: `test-`プレフィックス）はプレゼンス対象外

## ブラウザタブタイトル

- 本番版: 「もじはんと」
- 開発版: 「もじはんとDEV」
