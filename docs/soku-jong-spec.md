# 速雀 / SOKU-JONG

> Claude Code 引き継ぎ仕様書 v2.0（2026-02-22 更新）

# 1. プロジェクト概要

速雀（soku-jong）は索子＋發・中のみを使った簡易ルール麻雀のWebゲーム。Three.jsによる3D牌レンダリングを特徴とし、React + Firebase によるリアルタイムマルチプレイヤー対応。

## 1.1 技術スタック

| 分類             | 技術                       | 備考                                  |
|------------------|----------------------------|---------------------------------------|
| 3Dレンダリング   | Three.js (r152+)           | @react-three/fiber + drei             |
| ポストプロセス   | postprocessing             | SSAO + Bloom（@react-three/postprocessing）|
| UIフレームワーク | React 18 + TypeScript      | Vite でビルド                         |
| スタイリング     | Tailwind CSS               | ユーティリティファーストCSS           |
| マルチプレイヤー | Firebase Realtime Database | リアルタイム同期                      |
| デプロイ         | GitHub Pages               | GitHub Actions 自動デプロイ           |
| フォント         | YujiSyuku / DS-DIGI        | 3Dテキスト用（局数・スコア表示）      |
| アイコン         | lucide-react               | Crown, Link 等                        |

# 2. 牌セット

合計44枚。副露（鳴き）なし。

| 牌種     | 枚数           | 赤牌  | 備考         |
|----------|----------------|-------|--------------|
| 1索〜9索 | 各4枚 (計36枚) | 各1枚 | 索子         |
| 發       | 4枚            | なし  | 緑の字牌     |
| 中       | 4枚            | なし  | 赤の字牌     |

赤牌の識別: 各牌IDに `isRed: boolean` フラグを持たせる。テクスチャは通常牌と別画像。

# 3. ゲームルール

## 3.1 基本ルール

| 項目       | 内容                           |
|------------|--------------------------------|
| プレイ人数 | 2〜4人                         |
| 持ち点     | 各40点                         |
| 形式       | 東風戦・連荘なし               |
| 配牌       | 5枚                            |
| ツモ       | 1枚ツモ → 6枚から1枚打牌 → 5枚 |
| 和了条件   | 2面子完成 + 5点以上            |
| 副露       | なし（チー・ポン・カン不可）   |
| 持ち時間   | 5分 or 無制限（ロビーで選択）  |

## 3.2 ドラ

- 局開始時に山札から1枚公開する
- その牌と同じ種類（索子の番号 or 字牌の種類）の全牌がドラとなる
- 赤牌も対象。例: 3索が公開された場合、赤3索もドラ
- 發・中もドラになりうる

## 3.3 和了条件・流局

- ツモ和了: 自分の番にツモって2面子が完成し、合計5点以上
- ロン和了: 他プレイヤーの打牌で2面子が完成し、合計5点以上
- フリテン: 自分の捨て牌に待ち牌が含まれている場合、ロン不可（ツモ和了は可）
- 流局: 山札が尽きた場合は点数のやり取りなし

## 3.4 ロン競合（頭ハネ）

- 複数人が同時ロン可能な場合、上家（打牌者から見て直近の前プレイヤー）が優先
- 優先順: 打牌者→上家→その上家→… の順に近い方が優先

# 4. 点数計算

## 4.1 基本点

| 種別 | 点数     | 条件                         |
|------|----------|------------------------------|
| 順子 | 1点/面子 | 3連続索子（例: 3-4-5索）     |
| 刻子 | 2点/面子 | 同牌3枚（例: 發×3）         |

## 4.2 ボーナス点

| ボーナス  | 点数   | 条件                                                        |
|-----------|--------|-------------------------------------------------------------|
| 赤牌      | 1点/枚 | 和了手に含まれる赤牌1枚ごと                                 |
| ドラ      | 1点/枚 | 和了手に含まれるドラ牌1枚ごと（赤牌がドラの場合は両方加算） |
| 親上がり  | +2点   | 親プレイヤーが和了した場合、最終得点に加算                   |

## 4.3 通常役

| 役名     | 点数 | 条件                                                                             |
|----------|------|----------------------------------------------------------------------------------|
| タンヤオ | 1点  | 全面子に1索, 9索, 發, 中が含まれない                                             |
| チャンタ | 1点  | 両面子にそれぞれ1索, 9索, 發, 中が1枚以上含まれる（順子: 1-2-3 や 7-8-9 もOK）  |

## 4.4 役満

**役満成立時は役満点数のみ。赤牌・ドラ・通常役のボーナスは加算しない。**

| 役名           | 点数  | 条件                                                                          |
|----------------|-------|-------------------------------------------------------------------------------|
| オールグリーン | 10点  | 2,3,4,6,8索（赤なし）・發のみで2面子。5索（赤・ノーマル問わず）不可           |
| チンヤオ       | 15点  | 1索,9索,發,中のみで2面子（実質: これらの刻子のみ）                            |
| スーパーレッド | 20点  | 赤1〜赤9索・中のみで2面子（中は赤牌ではないが赤いビジュアルなので含む）       |

## 4.5 点数精算

- ロン: 放銃者1人が和了点を全額支払う
- ツモ: 和了点を人数で割り、端数は切り上げ。全員が均等に支払う（親倍なし）
- 持ち点が0以下になったプレイヤーは脱落（または即終了: 要確認）

# 5. ゲームフロー

## 5.1 局の流れ

| ステップ          | 処理内容                                                     |
|-------------------|--------------------------------------------------------------|
| 1. 局開始         | 山札シャッフル（44枚）                                       |
| 2. ドラ公開       | 山札から1枚表向きに公開。同種牌がドラになる                   |
| 3. 配牌           | 全プレイヤーに5枚ずつ配る                                    |
| 4. 手番開始       | 現在プレイヤーが山札からツモ（1枚）                          |
| 5. 打牌           | 手牌6枚から1枚選択して捨てる                                 |
| 6. ロンチェック   | 打牌の瞬間、他プレイヤー全員の和了チェック（頭ハネ適用）     |
| 7. ツモチェック   | ツモ時に和了チェック（ツモ和了）                              |
| 8. 次の手番       | 時計回りで次プレイヤーへ                                     |
| 9. 局終了         | 和了 or 山札切れで局終了 → 点数精算                          |
| 10. 次局 or 終了  | 東風戦（4局）終了後、最高点プレイヤーが勝者                  |

## 5.2 手番の状態遷移

```
turnPhase='draw' → processDraw() → turnPhase='discard'（canTsumoならツモボタン表示）
  → 手牌クリック → processDiscard() → turnPhase='ron_check'
  → checkRonCandidates() → ロン可能者にロンボタン / なければ次手番
  → getNextTurnPlayerId() → turnPhase='draw' に戻る
```

# 6. データモデル（TypeScript型定義）

## 6.1 牌

```typescript
type TileKind = '1s'|'2s'|'3s'|'4s'|'5s'|'6s'|'7s'|'8s'|'9s'|'hatsu'|'chun';

interface Tile {
  id: string;       // 一意ID: "3s_r" (赤3索), "3s_2" (2枚目の3索)
  kind: TileKind;
  isRed: boolean;
}
```

## 6.2 面子

```typescript
type MentsuType = 'shuntsu' | 'koutsu'; // 順子 | 刻子

interface Mentsu {
  type: MentsuType;
  tiles: [Tile, Tile, Tile];
}
```

## 6.3 プレイヤー

```typescript
interface Player {
  id: string;
  name: string;
  hand: Tile[];        // 手牌（通常5枚, ツモ後6枚）
  discards: Tile[];    // 捨て牌（フリテン判定用）
  score: number;       // 持ち点
  isDealer: boolean;   // 親フラグ
  seatOrder: number;   // 座席順（0-3, 上家判定用）
}
```

## 6.4 ゲーム設定

```typescript
interface GameSettings {
  initialScore: number;     // 初期持ち点（デフォルト40）
  totalRounds: number;      // 東風戦の局数（デフォルト4）
  timeLimitSeconds: number; // 持ち時間（0=無制限, 300=5分）
}
```

## 6.5 和了結果

```typescript
interface RoundResult {
  type: 'tsumo' | 'ron' | 'draw';     // 和了種別 or 流局
  winnerId?: string;
  loserId?: string;                     // ロン時の放銃者
  winnerHand?: Tile[];                  // 和了者の手牌（表示用）
  score?: ScoreResult;
  prevScores?: Record<string, number>; // 和了確定前の各プレイヤースコア
}
```

## 6.6 点数計算結果

```typescript
interface ScoreResult {
  total: number;
  breakdown: {
    mentsu: number;   // 面子点
    red: number;      // 赤牌
    dora: number;     // ドラ
    dealer: number;   // 親ボーナス
    tanyao: number;   // タンヤオ
    chanta: number;   // チャンタ
  };
  yakuman: YakumanType | null;  // 'all-green' | 'chinroto' | 'super-red'
  yakumanPoints: number;
}
```

## 6.7 ゲーム状態（Firebase同期）

```typescript
type GamePhase = 'waiting' | 'playing' | 'round_result' | 'finished';
type TurnPhase = 'draw' | 'discard' | 'ron_check';

interface GameState {
  phase: GamePhase;
  players: Player[];
  round: number;                        // 1〜4 (東1〜東4局)
  currentTurn: string | null;           // 現在の手番プレイヤーID
  deck: Tile[];                         // 残り山札
  doraTile: Tile | null;                // ドラ表示牌
  lastDiscard: Tile | null;             // 直前の打牌
  lastDiscardPlayerId: string | null;
  turnPhase?: TurnPhase;
  settings: GameSettings;
  roundResult?: RoundResult;            // 局結果
  timeBank?: Record<string, number>;    // プレイヤーごとの持ち時間（秒）
}
```

## 6.8 部屋データ

```typescript
interface RoomData {
  hostId: string;
  gameState: GameState;
  createdAt: number;
}
```

# 7. 和了判定・役判定ロジック

## 7.1 2面子判定アルゴリズム

手牌5枚（ロン時は打牌を加えた6枚）から2面子を抽出できるかを判定する。

- 刻子チェック: 同種牌が3枚以上あるか
- 順子チェック: 連続する索子3枚が存在するか（字牌は順子不可）
- バックトラッキング: 全組み合わせを探索し、有効な2面子構成を列挙
- 複数の面子構成が存在する場合、最高点の構成を採用する

## 7.2 役満チェック（優先順位: 高→低）

| 優先度 | 役名           | チェック方法                                                 |
|--------|----------------|--------------------------------------------------------------|
| 1      | スーパーレッド | 全6牌が赤索子 or 中のみで構成されているか                    |
| 2      | チンヤオ       | 全6牌が1索, 9索, 發, 中のみで構成されているか                |
| 3      | オールグリーン | 全6牌が2,3,4,6,8索（非赤）, 發のみで構成されているか         |

役満が成立した場合、通常役・ボーナスの計算をスキップし役満点のみを返す。

## 7.3 フリテン判定

自分の捨て牌に待ち牌が含まれている場合、ロン不可（ツモ和了は可）。

## 7.4 待ち牌計算

テンパイ（手牌5枚）時に全11種の牌を仮想的に加えて和了判定を行い、和了可能な牌種のリストを返す（`findWaitingTiles()`）。

# 8. 3Dレンダリング仕様

## 8.1 Three.js シーン構成

| 要素         | 実装                                                                              |
|--------------|-----------------------------------------------------------------------------------|
| カメラ       | PerspectiveCamera `[0,6,5]` FOV=35, target=`[0,0,0.4]`                          |
| ライティング | Environment studio (intensity=0.1) + AmbientLight + DirectionalLight×2           |
| ポストプロセス | SSAO (samples=8〜16, radius=0.08〜0.1) + Bloom (intensity=0.15)                |
| 卓           | PlaneGeometry + フェルト風テクスチャ（放射グラデーション+微細ノイズ）             |
| 卓枠         | RoundedBoxGeometry（角丸）+ Canvas生成の木目テクスチャ                            |
| 中央パネル   | 3層構造: 外枠(黒革風) + 溝底(黒) + 内枠(漆塗り風)                               |
| ターンランプ | 台形メッシュ（手番プレイヤーが赤く光る）                                         |
| 風パネル     | 角丸正方形 + ボーダー付き（自家=赤+金、他家=白+灰）                             |
| スコア表示   | デジタルフォント(DS-DIGI)で赤色LED風表示                                          |
| ドラ牌       | 中央パネル内に縮小表示                                                            |
| グラフィック品質 | 高品質/標準の切り替え（localStorage保存）                                      |

## 8.2 牌の3Dモデル（TileModel）

**サイズ**: 幅 0.24 / 高さ 0.30 / 厚み 0.17 (Three.js units)

**形状**: RoundedBoxGeometry（radius=0.02, segments=3）

**マテリアル（MeshPhysicalMaterial）**:
- 側面: アイボリー(#f5f0e8) + ブラウン(#cc9900) の色分け。clearcoat=0.8
- 絵柄面(+Z): テクスチャ画像 + bumpMapで彫り込み表現
- 背面(-Z): ブラウン(#cc9900) 単色

**テクスチャ画像パス**: `/hive/images/soku-jong/`
- 通常牌: `soku_s{1-9}.png`, `soku_hatsu.png`, `soku_chun.png`
- 赤牌: `soku_r_s{1-9}.png`

**配置**:
- 自家の手牌: 表向き＋傾斜 (`rotation=[-π/2+0.3, 0, 0]`)
- 他家の手牌: 直立裏面
- 河の牌: 寝かせ表向き (`rotation=[-π/2, 0, 0]`)
- ツモ牌: 手牌6枚目を少し右にずらして配置 (gap=0.1)

## 8.3 河（捨て牌）の配置

- 6枚で折り返し（`RIVER_COLS = 6`）
- 2段目以降は手前方向に配置（`RIVER_Z + row * RIVER_ROW_SPACING`）
- 各家の河はY軸回転でそれぞれの方向を向く

| プレイヤー位置 | Y軸回転  | 並び方向          |
|----------------|----------|-------------------|
| 自分（下）     | 0度      | 左→右、中央向き   |
| 右家           | -90度    | 上→下、中央向き   |
| 対面（上）     | 180度    | 右→左、中央向き   |
| 左家           | 90度     | 下→上、中央向き   |

## 8.4 卓のマテリアル

**テーブル面**
- Canvas生成テクスチャ（512×512）
- 放射グラデーション: 中央 #1f6b32 → 端 #1a5c2a
- ピクセルノイズ（±12）でフェルトの繊維感を表現
- MeshPhysicalMaterial: roughness=0.95, sheen=0.8, sheenColor=#2a8a45

**テーブル枠**
- RoundedBoxGeometry（radius=0.02）で角丸
- Canvas生成の木目テクスチャ（256×64）: ダークブラウン #3d2b1f ベース
- MeshPhysicalMaterial: roughness=0.5, clearcoat=0.4

# 9. UI仕様

## 9.1 画面遷移

```
ルーム作成/参加画面
  → ルームロビー（参加者一覧・設定）
    → ゲーム画面（playing / round_result）
      → 最終結果画面（finished）
        → ロビーに戻る
```

## 9.2 ルームロビー

```
┌──────────────────────────────────┐
│        速雀ロゴ                  │
│    簡易麻雀ゲーム                │
│                                  │
│  ┌────────────────────────────┐  │
│  │    ルームコード: ABCD      │  │
│  └────────────────────────────┘  │
│  [ 招待リンクをコピー ]          │
│                                  │
│  ┌──────────┐ ┌──────────┐      │
│  │ 参加者    │ │ 持ち時間 │      │
│  │ (2/4人)   │ │          │      │
│  │ 👑 太郎   │ │ [5分]    │      │
│  │ 花子      │ │ [無制限] │      │
│  └──────────┘ └──────────┘      │
│                                  │
│  [ ゲーム開始 ]                  │
│  [ 退出 ]                        │
└──────────────────────────────────┘
```

- 招待リンクの下を2カラムに分割（左: 参加者一覧、右: 持ち時間設定）
- 持ち時間はホストのみ変更可能（5分 / 無制限）
- ゲーム開始ボタンはホストのみ有効、2人以上で開始可能
- ルームコード・招待リンクはクリックでコピー（トースト通知）

## 9.3 ゲーム画面

```
┌──────────────────────────────────────┐
│ [←ロビー] 速雀ロゴ [品質] 東1局 手番│  ← ヘッダー
├──────────────────────────────────────┤
│                                      │
│        [対面の手牌（裏向き）]        │
│           [対面の河]                 │
│                                      │
│  [左の河]  ┌──────────┐  [右の河]   │
│            │ 東一局   │             │
│            │ 残 18    │             │  ← 3D Canvas
│            │ ドラ:[牌]│             │
│            └──────────┘             │
│           [自分の河]                 │
│    ──────────────────────            │
│   [自分の手牌（表向き・3D）]        │
│                                      │
│         ┌─────────────┐              │
│         │ 待ち [牌][牌]│             │  ← 2Dオーバーレイ
│         └─────────────┘              │
│                                      │
│   [ツモ] [ロン] [見逃し]            │  ← 3Dボタン（条件付き表示）
└──────────────────────────────────────┘
```

### ヘッダー
- ロビーに戻るボタン、速雀ロゴ、グラフィック品質切替、局数、手番表示、持ち時間

### 3D Canvas
- TableScene: 卓・牌・中央パネル・ボタン
- OrbitControls: ドラッグで視点変更可能

### 待ち牌パネル（2Dオーバーレイ）
- テンパイ（手牌5枚）時に手牌の上に表示
- 黒背景パネル + 「待ち」ラベル + 牌画像
- 牌画像は TileModel と同じテクスチャパスの `<img>` タグで表示
- 結果モーダル表示中は非表示

### 操作ボタン（3Dメッシュ）
- ツモボタン: 自分の手番 + ツモ和了可能時に赤ボタン表示
- ロンボタン + 見逃しボタン: ロン可能時に表示
- 手牌クリック: 打牌フェーズ（手牌6枚）時にクリックで打牌

### ホバー演出
- 打牌可能な手牌にホバーすると Y+0.05 浮き上がり + カーソルpointer

## 9.4 和了結果モーダル（round_result）

3Dシーンの上にモーダルオーバーレイとして表示（画面遷移なし）。2ステップ構成。

### ステップ1: 和了結果

```
┌──────────────────────────────────┐
│     東1局  ツモ和了 / ロン       │
│                                  │
│  [牌][牌][牌][牌][牌] [上がり牌] │  ← 2D牌画像
│                                  │
│  面子点    2点                   │
│  赤牌      1点                   │
│  ────────────────                │
│  合計      8点                   │
│                                  │
│  [ 次へ → ]                     │
└──────────────────────────────────┘
```

- 和了者の手牌を2D牌画像（アイボリー背景カード + テクスチャ画像）で表示
- 5枚 + ツモ/ロン牌の間にスペーサー
- 点数内訳（面子点・赤牌・ドラ・親ボーナス・タンヤオ・チャンタ）を表示。0点の項目は非表示
- 役満時は役名 + 役満点数のみ
- 「次へ →」で点数移動画面に遷移

### ステップ2: 点数移動

```
┌──────────────────────────────────┐
│         点数移動                 │
│                                  │
│  プレイヤー1   40 → 48  (+8)    │
│  プレイヤー2   40 → 37  (-3)    │
│  プレイヤー3   40 → 37  (-3)    │
│  プレイヤー4   40 → 38  (-2)    │
│                                  │
│  [ロビーに戻る] [次の局へ]       │
└──────────────────────────────────┘
```

- prevScores（和了確定前）と現在スコアの差分を表示
- 勝者は赤背景、敗者（ロン時）は青背景
- 得点は赤文字(+N)、失点は青文字(-N)

### 流局時
- ステップ1のみ（点数移動なし）
- 「ロビーに戻る」「次の局へ」ボタンを直接表示

## 9.5 最終結果画面（finished）

- 対局終了ヘッダー + ランキング表示（スコア降順）
- 1位は金色ハイライト
- 「ロビーに戻る」ボタン

## 9.6 ローディングオーバーレイ

- 3Dシーン読み込み中にプログレスバー付きオーバーレイを表示
- 完了後300msでフェードアウト

# 10. React コンポーネント構成

```
SokuJongGame.tsx — ゲーム全体管理（フェーズ分岐）
├── Lobby.tsx — ロビー画面（ルーム作成/参加・設定・2カラム表示）
├── GameScreen.tsx — ゲーム操作ハブ（ゲームループ・持ち時間・bot・結果モーダル・待ち牌パネル）
│   └── TableScene.tsx — 3Dシーン（卓・牌配置・3Dボタン）
│       └── TileModel.tsx — 牌3Dモデル（テクスチャ・マテリアル・クリック/ホバー）
└── TileTestPage.tsx — 牌テスト表示ページ（/soku-jong/test）
```

### 各コンポーネントの責務

| コンポーネント | 責務 |
|----------------|------|
| `SokuJongGame` | フェーズ分岐（waiting/playing/round_result/finished）、次局・ロビー復帰ハンドラ |
| `Lobby` | ルーム作成/参加、2カラムUI（参加者+持ち時間）、招待リンク |
| `GameScreen` | ゲームループ（draw→discard→ron_check）、Bot自動プレイ、持ち時間管理、待ち牌2Dパネル、結果モーダルオーバーレイ |
| `TableScene` | 3Dシーン全体（卓・牌配置・中央パネル・ボタン・OrbitControls） |
| `TileModel` | 牌の3Dメッシュ（RoundedBox + テクスチャ + bumpMap + イベント） |

# 11. Firebase 構成

## 11.1 Realtime Database スキーマ

```
rooms/
  {roomCode}/
    hostId: string
    createdAt: number
    gameState: GameState     // ゲーム全体の状態（JSON）
```

- `roomCode` は4桁英数字
- GameState 全体を1つのオブジェクトとして保存（手牌含む）
- undefined 値は Firebase 保存前に除去（`removeUndefined()` ユーティリティ）

## 11.2 ルーム管理（useRoom フック）

| 機能 | 説明 |
|------|------|
| `createRoom()` | ルーム作成（4桁コード生成、ホスト登録） |
| `joinRoom(code)` | ルーム参加（プレイヤー追加） |
| `leaveRoom()` | ルーム退出（プレイヤー削除、空なら部屋削除） |
| `updateGameState()` | GameState 部分更新（Firebase に同期） |
| `addTestPlayer()` | テストBot追加（`test-` prefix） |

## 11.3 URL招待

- 招待リンク: `{origin}/hive/soku-jong?room={roomCode}`
- URLパラメータ `room` からの自動参加（初回のみ、`hasAutoJoined` ref で制御）

# 12. Bot自動プレイ

テストプレイヤー（ID が `test-` で始まる）の手番を自動処理。

| フェーズ | Bot動作 |
|----------|---------|
| draw     | 自動ツモ。和了可能なら即ツモ和了 |
| discard  | 800ms 後にツモ切り（最後の牌を捨てる） |
| ron_check | ロン可能なら自動ロン |

# 13. 持ち時間管理

- `GameSettings.timeLimitSeconds`: 0（無制限）or 300（5分）
- `GameState.timeBank`: プレイヤーごとの残り時間（秒）
- アクション必要時（discard/tsumo/ron判断）にカウントダウン開始
- 時間切れ時の自動行動: ロン→見逃し、ツモ→和了、打牌→最後の牌を捨てる
- ヘッダーに残り時間表示（30秒以下で赤色）

# 14. 切断・再接続の仕組み（未実装）

## 14.1 切断検知
- Firebase Realtime Database の `onDisconnect()` で切断検知
- `isConnected: boolean` フラグをDBに書き込み

## 14.2 切断中の自動ツモ切り
- ホストが代理でツモ切り処理を実行
- ロン可能でも見逃し扱い

## 14.3 再接続
- 同じルームに再接続で復帰。巻き戻しなし

## 14.4 ホスト引き継ぎ
- ホスト切断時、最もseatOrderが若いプレイヤーがホスト権限を引き継ぐ

# 15. 実装フェーズと進捗

| フェーズ | 内容 | 状態 |
|----------|------|------|
| Phase 1 | 卓3Dビジュアル（フェルト面・木枠・牌モデル・4家配置・ライティング・ポストプロセス） | **完了** |
| Phase 2 | ゲームループUI接続（ツモ/打牌/ロン/流局・Bot自動プレイ・持ち時間・テンパイ待ち牌） | **完了** |
| Phase 3 | マルチプレイヤー（Firebase同期・ルーム管理・ロン/フリテン判定・頭ハネ） | **完了** |
| Phase 4 | 切断・再接続対応（onDisconnect・自動ツモ切り・ホスト引き継ぎ） | 未着手 |
| Phase 5 | 仕上げ（アニメーション・モバイル対応） | 未着手 |

# 16. 主要ファイル一覧

| ファイル | 役割 |
|----------|------|
| `types/game.ts` | 型定義（Tile, Player, GameState, RoundResult, GameSettings 等） |
| `lib/tile-deck.ts` | デッキ生成・シャッフル・配牌・ツモ |
| `lib/win-detector.ts` | 2面子判定（バックトラッキング） |
| `lib/furiten.ts` | 待ち牌計算・フリテン判定・ロン可否 |
| `lib/scoring.ts` | 点数計算（基本点+ボーナス+役満）、ScoreResult型 |
| `lib/game-flow.ts` | 局初期化・ツモ/打牌/ロン精算・流局・次手番・勝敗判定 |
| `hooks/useRoom.ts` | Firebase連携（ルーム管理・プレゼンス・状態同期） |
| `components/Lobby.tsx` | ロビー画面（ルーム作成/参加・2カラム設定） |
| `components/GameScreen.tsx` | ゲーム操作ハブ（ループ・持ち時間・bot・結果モーダル・待ち牌パネル） |
| `components/TableScene.tsx` | 3Dシーン（卓・牌配置・ボタン） |
| `components/TileModel.tsx` | 牌3Dモデル（テクスチャ・マテリアル・クリック/ホバー） |
| `SokuJongGame.tsx` | ゲーム全体管理（フェーズ分岐・結果画面） |

# 17. 補足・注意事項

- GitHub Pages デプロイ: `vite.config.ts` の `base` を `"/hive/"` に設定
- MeshPhysicalMaterial は WebGL2 必須（iOS Safari 15+ 対応）
- 全牌テクスチャ(20種)をモジュールレベルでプリロード（画面チラつき防止）
- ドラが赤牌の場合: ドラボーナス1点 + 赤牌ボーナス1点 = 計2点が加算
- 和了点の最低ラインは5点（面子点 + ボーナス点の合計）。5点未満はツモ切り扱い
- Firebase に undefined 値を書き込むとエラーになるため、更新前に `removeUndefined()` で除去
- CLAUDE.md はコミット・プッシュしない（ローカル専用）

--- 仕様書ここまで ---
