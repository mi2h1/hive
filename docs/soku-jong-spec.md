# 速雀 / SOKU-JONG

> Claude Code 引き継ぎ仕様書 v1.0

# 1. プロジェクト概要

速雀（soku-jong）は索子＋發・中のみを使った簡易ルール麻雀のWebゲーム。Three.jsによる3D牌レンダリングを特徴とし、React + Firebase によるリアルタイムマルチプレイヤー対応を目指す。

## 1.1 技術スタック

|                  |                            |                                    |
|------------------|----------------------------|------------------------------------|
| **分類**         | **技術**                   | **備考**                           |
| 3Dレンダリング   | Three.js (r152+)           | MeshPhysicalMaterialで牌の質感表現 |
| UIフレームワーク | React 18 + TypeScript      | Vite でビルド                      |
| 状態管理         | Zustand                    | ゲーム状態・プレイヤー状態         |
| マルチプレイヤー | Firebase Realtime Database | リアルタイム同期                   |
| デプロイ         | GitHub Pages               | Vite の base 設定必須              |

# 2. 牌セット

合計44枚。副露（鳴き）なし。

|          |                |          |                  |
|----------|----------------|----------|------------------|
| **牌種** | **枚数**       | **赤牌** | **備考**         |
| 1索〜9索 | 各4枚 (計36枚) | 各1枚    | Unicode: 🀐〜🀘    |
| 發       | 4枚            | なし     | Unicode: 🀅 / 緑  |
| 中       | 4枚            | なし     | Unicode: 🀄 / 赤 |

赤牌の識別: 各牌IDに isRed: boolean フラグを持たせる。ビジュアルは文字色を赤 (#e00) にする。

# 3. ゲームルール

## 3.1 基本ルール

|            |                                |
|------------|--------------------------------|
| **項目**   | **内容**                       |
| プレイ人数 | 2〜4人                         |
| 持ち点     | 各40点                         |
| 形式       | 東風戦・連荘なし               |
| 配牌       | 5枚                            |
| ツモ       | 1枚ツモ → 6枚から1枚打牌 → 5枚 |
| 和了条件   | 2面子完成 + 5点以上            |
| 副露       | なし（チー・ポン・カン不可）   |
| 山牌       | なし（カードゲーム的な山札）   |

## 3.2 ドラ

- 局開始時に山札から1枚公開する

- その牌と同じ種類（索子の番号 or 字牌の種類）の全牌がドラとなる

- 赤牌も対象。例: 3索が公開された場合、赤3索もドラ

- 發・中もドラになりうる

## 3.3 和了条件・流局

- ツモ和了: 自分の番にツモって2面子が完成し、合計5点以上

- ロン和了: 他プレイヤーの打牌で2面子が完成し、合計5点以上

- フリテン: 自分の捨て牌に待ち牌が含まれている場合、ロン不可（ツモ和了は可）

- 流局: 山札が尽きた場合は点数のやり取りなし

## 3.4 ロン競合（頭ハネ）

- 複数人が同時ロン可能な場合、上家（打牌者から見て直近の前プレイヤー）が優先

- 優先順: 打牌者→上家→その上家→… の順に近い方が優先

# 4. 点数計算

## 4.1 基本点

|          |          |                          |
|----------|----------|--------------------------|
| **種別** | **点数** | **条件**                 |
| 順子     | 1点/面子 | 3連続索子（例: 3-4-5索） |
| 刻子     | 2点/面子 | 同牌3枚（例: 發×3）      |

## 4.2 ボーナス点

|              |          |                                                             |
|--------------|----------|-------------------------------------------------------------|
| **ボーナス** | **点数** | **条件**                                                    |
| 赤牌         | 1点/枚   | 和了手に含まれる赤牌1枚ごと                                 |
| ドラ         | 1点/枚   | 和了手に含まれるドラ牌1枚ごと（赤牌がドラの場合は両方加算） |
| 親上がり     | +2点     | 親プレイヤーが和了した場合、最終得点に加算                  |

## 4.3 通常役

|          |          |                                                                                 |
|----------|----------|---------------------------------------------------------------------------------|
| **役名** | **点数** | **条件**                                                                        |
| タンヤオ | 1点      | 全面子に1索, 9索, 發, 中が含まれない                                            |
| チャンタ | 1点      | 両面子にそれぞれ1索, 9索, 發, 中が1枚以上含まれる （順子: 1-2-3 や 7-8-9 もOK） |

## 4.4 役満

**役満成立時は役満点数のみ。赤牌・ドラ・通常役のボーナスは加算しない。**

|                |          |                                                                          |
|----------------|----------|--------------------------------------------------------------------------|
| **役名**       | **点数** | **条件**                                                                 |
| オールグリーン | 10点     | 2,3,4,6,8索（赤なし）・發のみで2面子 5索（赤・ノーマル問わず）不可       |
| チンヤオ       | 15点     | 1索,9索,發,中のみで2面子 （実質: これらの刻子のみ）                      |
| スーパーレッド | 20点     | 赤1〜赤9索・中のみで2面子 （中は赤牌ではないが赤いビジュアルなので含む） |

## 4.5 点数精算

- ロン: 放銃者1人が和了点を全額支払う

- ツモ: 和了点を人数で割り、端数は切り上げ。全員が均等に支払う（親倍なし）

- 持ち点が0以下になったプレイヤーは脱落（または即終了: 要確認）

# 5. ゲームフロー

## 5.1 局の流れ

|                   |                                                          |
|-------------------|----------------------------------------------------------|
| **ステップ**      | **処理内容**                                             |
| 1\. 局開始        | 山札シャッフル（44枚）                                   |
| 2\. ドラ公開      | 山札から1枚表向きに公開。同種牌がドラになる              |
| 3\. 配牌          | 全プレイヤーに5枚ずつ配る                                |
| 4\. 手番開始      | 現在プレイヤーが山札からツモ（1枚）                      |
| 5\. 打牌          | 手牌6枚から1枚選択して捨てる                             |
| 6\. ロンチェック  | 打牌の瞬間、他プレイヤー全員の和了チェック（頭ハネ適用） |
| 7\. ツモチェック  | ツモ時に和了チェック（ツモ和了）                         |
| 8\. 次の手番      | 時計回りで次プレイヤーへ                                 |
| 9\. 局終了        | 和了 or 山札切れで局終了 → 点数精算                      |
| 10\. 次局 or 終了 | 東風戦（4局）終了後、最高点プレイヤーが勝者              |

## 5.2 手番の状態遷移

> WAITING → MY_TURN → DRAWING → TSUMO_CHECK → DISCARD → RON_CHECK → WAITING

# 6. データモデル (TypeScript型定義)

## 6.1 牌

> type TileKind = '1s'\|'2s'\|'3s'\|'4s'\|'5s'\|'6s'\|'7s'\|'8s'\|'9s'\|'hatsu'\|'chun';
>
> interface Tile {
>
> id: string; // 一意ID: "3s_r" (赤3索), "3s_2" (2枚目の3索)
>
> kind: TileKind;
>
> isRed: boolean;
>
> }

## 6.2 面子

> type MentsuType = 'shuntsu' \| 'koutsu'; // 順子 \| 刻子
>
> interface Mentsu {
>
> type: MentsuType;
>
> tiles: \[Tile, Tile, Tile\];
>
> }

## 6.3 プレイヤー

> interface Player {
>
> id: string;
>
> name: string;
>
> hand: Tile\[\]; // 手牌（通常5枚, ツモ後6枚）
>
> discards: Tile\[\]; // 捨て牌（フリテン判定用）
>
> score: number; // 持ち点
>
> isDealer: boolean; // 親フラグ
>
> seatOrder: number; // 座席順（0-3, 上家判定用）
>
> }

## 6.4 ゲーム状態（Firebase Realtime DB）

> interface GameState {
>
> gameId: string;
>
> phase: "waiting"\|"playing"\|"finished";
>
> round: number; // 1〜4 (東1〜東4局)
>
> currentTurn: string; // 現在の手番プレイヤーID
>
> deck: Tile\[\]; // 残り山札
>
> doraTile: Tile; // ドラ表示牌
>
> players: Player\[\];
>
> lastDiscard: Tile \| null; // 直前の打牌
>
> lastDiscardPlayerId: string \| null;
>
> }

# 7. 和了判定・役判定ロジック

## 7.1 2面子判定アルゴリズム

手牌5枚（ロン時は打牌を加えた6枚）から2面子を抽出できるかを判定する。

- 刻子チェック: 同種牌が3枚以上あるか

- 順子チェック: 連続する索子3枚が存在するか（字牌は順子不可）

- バックトラッキング: 全組み合わせを探索し、有効な2面子構成を列挙

- 複数の面子構成が存在する場合、最高点の構成を採用する

## 7.2 役満チェック（優先順位: 高→低）

|            |                |                                                      |
|------------|----------------|------------------------------------------------------|
| **優先度** | **役名**       | **チェック方法**                                     |
| 1          | スーパーレッド | 全6牌が赤索子 or 中のみで構成されているか            |
| 2          | チンヤオ       | 全6牌が1索, 9索, 發, 中のみで構成されているか        |
| 3          | オールグリーン | 全6牌が2,3,4,6,8索（非赤）, 發のみで構成されているか |

役満が成立した場合、通常役・ボーナスの計算をスキップし役満点のみを返す。

## 7.3 フリテン判定

> // 自分の捨て牌に待ち牌が含まれていたらロン不可
>
> const isFuriten = (player: Player, winTile: Tile): boolean =\> {
>
> return player.discards.some(d =\> d.kind === winTile.kind);
>
> };

# 8. 3Dレンダリング仕様

## 8.1 Three.js シーン構成

|              |                                                          |
|--------------|----------------------------------------------------------|
| **要素**     | **実装方針**                                             |
| カメラ       | 固定 PerspectiveCamera（斜め上から卓を見下ろすアングル） |
| ライティング | AmbientLight + DirectionalLight × 2（正面 + 側面）       |
| 卓           | PlaneGeometry + MeshLambertMaterialでフェルト質感        |
| 山札         | 牌を積み重ねた3Dスタック表示                             |
| ドラ牌       | 表向きで少し傾けて配置                                   |

## 8.2 牌の3Dモデル

*※ 以下はデザイン仕様の意図を示すもの。具体的な実装方法はThree.jsのバージョンや環境により変わりうる。*

**サイズ（実物比）**

- 幅: 約0.26 / 高さ: 約0.35 / 厚み: 約0.18 (Three.js units、実物に近い縦横比)

**形状**

- 6面はすべてフラット（平面）

- 12辺と8頂点はベベル処理で丸める（面取り）。ユリア樹脂・アクリル牌の実物に近い質感

- 実装には RoundedBoxGeometry（Three.js r140+ の addons に含まれる）の使用を推奨

**マテリアル**

- MeshPhysicalMaterial を使用。clearcoat + transmission でアクリル・ユリア樹脂の光沢感を表現

- 表面（絵柄面）: 象牙色ベース + 画像テクスチャ（絵柄）

- 背面: 薄いブラウン単色

- 4つの側面: 表面側 5/6 はアイボリー、背面側 1/6 はブラウンでくっきり色分け（実物の牌断面に近い表現）

## 8.3 牌テクスチャ生成

- 絵柄は別途用意した画像ファイルを使用する（Canvas動的生成ではなく静的アセット）

- 11種類の牌それぞれに画像を用意: 1〜9索、發、中

- 赤牌は通常牌と別画像、またはオーバーレイで赤みを乗せる方式どちらでも可

- ドラ牌: 枠に金色のボーダーをオーバーレイで追加

- 画像フォーマット: PNG推奨（透過不要だがアルファ付きでも可）

## 8.4 卓のマテリアル

> // フェルト質感
>
> new THREE.MeshStandardMaterial({
>
> color: 0x1a5c2a, // 深いグリーン
>
> roughness: 0.9,
>
> metalness: 0.0,
>
> // nomalMap: フェルト布目テクスチャ（任意）
>
> })

## 8.5 アニメーション

|                |                                                              |
|----------------|--------------------------------------------------------------|
| **アクション** | **アニメーション**                                           |
| ホバー         | 牌が Y軸方向に0.05units 浮き上がる（GSAP or Three.js Tween） |
| 打牌           | 牌が卓中央方向にスライドし、フラットに倒れる                 |
| ツモ           | 山札から手牌エリアへスライドイン                             |
| 和了           | 和了牌がスポットライトで光る演出                             |

# 9. UIレイアウト

## 9.1 画面構成

> ┌──────────────────────────────────────────┐
>
> │ \[対面プレイヤー名・点数・手牌（裏向き）\] │
>
> │ \[対面の河（180度回転・中央向き）\] │
>
> │ │
>
> │ \[左の河 ┌────────────────────┐ 右の河\] │
>
> │ (90度 │ 東2局 残18枚 │ (270度 │
>
> │ 回転) │ ドラ: \[牌\] │ 回転) │
>
> │ │ 山札スタック │ │
>
> │ └────────────────────┘ │
>
> │ \[自分の河（正位置・中央向き）\] │
>
> │ ────────────────────────────────────── │
>
> │ \[自分の手牌・表向き 3D牌\] │
>
> │ \[ボタン: ツモ切り / 選択打牌 / ロン\] │
>
> └──────────────────────────────────────────┘

中央情報エリアはThree.jsシーン上にHTML/CSSをオーバーレイして実装（文字の視認性が高く実装も容易）。

|              |                                    |
|--------------|------------------------------------|
| **表示要素** | **内容**                           |
| 局数         | 東1局〜東4局                       |
| 残牌数       | 残○○枚                             |
| ドラ表示     | ドラ牌を3Dで表示（少し傾けて配置） |
| 山札         | 牌を積み重ねた3Dスタック           |

## 9.2 河（捨て牌）の表示ルール

|                    |             |                       |
|--------------------|-------------|-----------------------|
| **プレイヤー位置** | **Y軸回転** | **並び方向**          |
| 自分（下）         | 0度         | 左→右に並ぶ、中央向き |
| 対面（上）         | 180度       | 右→左に並ぶ、中央向き |
| 左                 | 90度        | 下→上に並ぶ、中央向き |
| 右                 | 270度       | 上→下に並ぶ、中央向き |

- 河の牌はすべて表向きで公開（全プレイヤーが確認可能）

- 自分の捨て牌はフリテン判定にも使用する（データと表示を共用）

## 9.3 React コンポーネント構成

> App
>
> ├── GameRoom (Firebase接続・ゲームループ管理)
>
> │ ├── ThreeCanvas (Three.jsシーン全体)
>
> │ │ ├── TableMesh (卓)
>
> │ │ ├── TileMesh × n (各牌の3Dオブジェクト)
>
> │ │ ├── DeckStack (山札)
>
> │ │ └── DoraTile (ドラ表示)
>
> │ ├── PlayerHand (自プレイヤーの手牌UI)
>
> │ ├── OpponentArea × n (対戦相手エリア)
>
> │ ├── ScoreBoard (点数表示)
>
> │ └── ActionButtons (ツモ切り / 打牌 / ロン宣言)
>
> └── Lobby (ルーム作成 / 参加)

# 10. Firebase 構成

## 10.1 Realtime Database スキーマ

> games/
>
> {gameId}/
>
> state: GameState // ゲーム全体の状態
>
> players/
>
> {playerId}/
>
> hand: Tile\[\] // 手牌（他プレイヤーには非公開）
>
> discards: Tile\[\] // 捨て牌（全員に公開）
>
> score: number
>
> actions/
>
> {timestamp}: Action // ロン宣言などのアクションキュー

## 10.2 セキュリティルール方針

- 手牌は自分のみ読み取り可能

- 山札はサーバーサイドルール（Cloud Functions）で管理することを推奨

- ただし初期実装はクライアントサイドで可（ホスト権限方式）

# 11. 切断・再接続の仕組み

## 11.1 切断検知

- Firebase Realtime Database の onDisconnect() を利用して切断を検知する

- 接続時にプレイヤーの接続状態（isConnected: boolean）をDBに書き込み、切断時に自動でfalseになるよう onDisconnect().set(false) を設定する

- 他プレイヤーはこのフラグを監視し、切断されたプレイヤーを画面上で「切断中」として表示する

## 11.2 切断中の自動ツモ切り

- 切断プレイヤーの手番が回ってきた場合、ホスト（または他の生存プレイヤー）が代理でツモ切り処理を実行する

- 自動ツモ切りはツモった牌をそのまま捨てる（手牌の選択は行わない）

- ロン可能な場面でも切断中はロン宣言を行わない（見逃し扱い）

- 自動ツモ切りには通常より短いタイムアウト（例: 3秒）を設けてゲームテンポを維持する

## 11.3 再接続

- 切断プレイヤーが同じgameIdに再接続した場合、isConnected をtrueに戻しゲームに復帰する

- 復帰時は現在のGameStateをそのまま受け取り、自分の手牌・捨て牌・点数を復元して続行する

- 切断中に自動ツモ切りされた分はそのまま反映済みの状態で復帰する（巻き戻しなし）

- 再接続のタイムアウトは設けない（局が終わるまでいつでも復帰可能）

## 11.4 全員切断・ホスト切断

- 全プレイヤーが切断した場合、gameIdのデータはFirebaseに残しておき再接続を待つ

- ホスト（部屋作成者）が切断した場合、残存プレイヤーの中で最もseatOrderが若いプレイヤーがホスト権限を引き継ぐ

# 12. 実装優先順位

|              |                                                                                                            |                              |
|--------------|------------------------------------------------------------------------------------------------------------|------------------------------|
| **フェーズ** | **内容**                                                                                                   | **目標**                     |
| Phase 1      | 牌の3Dモデル表示 ・RoundedBoxGeometry + MeshPhysicalMaterial ・画像テクスチャで絵柄描画 ・ライティング調整 | 牌1枚を美しく表示できる状態  |
| Phase 2      | ソロ動作確認 ・山札シャッフル・配牌 ・ツモ→打牌のループ ・和了判定・点数計算                               | 1人でゲームが一通り動く状態  |
| Phase 3      | マルチプレイヤー ・Firebaseリアルタイム同期 ・ロン・フリテン判定 ・ルーム作成/参加UI                       | 複数人で対戦できる状態       |
| Phase 4      | 切断・再接続対応 ・onDisconnect設定 ・自動ツモ切り ・ホスト引き継ぎ                                        | 切断があっても続行できる状態 |
| Phase 5      | 仕上げ ・アニメーション追加 ・スコアボード・東風戦管理 ・モバイル対応                                      | 完成品                       |

# 13. 補足・注意事項

- GitHub Pages へのデプロイ: vite.config.ts の base を "/soku-jong/" に設定すること

- Three.js の WebGLRenderer は canvas 要素に直接レンダリングするため、React の useEffect でマウント管理が必要

- MeshPhysicalMaterial は WebGL2 必須。iOS Safari 15+ 以降で対応

- 牌の絵柄は静的画像アセット（PNG等）を使用する。画像が未用意の段階は仮のCanvasテクスチャや番号表示でプレースホルダー対応可

- ドラが赤牌の場合: ドラボーナス1点 + 赤牌ボーナス1点 = 計2点が加算される

- 和了点の最低ラインは5点（面子点 + ボーナス点の合計）。5点未満はツモ切り扱い

--- 仕様書ここまで ---
