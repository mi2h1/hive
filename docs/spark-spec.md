# SPARK 仕様書

## ゲーム概要

SPARKは宝石を奪い合う心理戦ゲーム。場の宝石台から宝石を取るか、他人の金庫を狙うか、それとも自分の金庫を守るか。同じ選択をした人がいると何も得られない「かぶり」の仕組みが、駆け引きを生む。

## 基本情報

- **プレイヤー人数**: 2〜6人
- **パス**: `/boards/spark`

## 宝石の種類と得点

| 色 | 得点 |
|----|------|
| 青 | 1点 |
| 黄 | 2点 |
| 赤 | 3点 |
| 白 | 所持数の2乗 |

### セットボーナス

- 青・黄・赤を1個ずつ持つと **+4点** のセットボーナス
- 複数セット可能（青2、黄2、赤2なら2セット=+8点）

### 白宝石の計算

白は個数の2乗で計算される:
- 1個 = 1点
- 2個 = 4点
- 3個 = 9点
- 4個 = 16点

## プレイヤー人数別設定

| 人数 | 台数 | 青 | 黄 | 赤 | 白 |
|------|------|-----|-----|-----|-----|
| 2人 | 3台 | 12 | 12 | 12 | 6 |
| 3人 | 2台 | 9 | 9 | 9 | 6 |
| 4人 | 3台 | 12 | 12 | 12 | 6 |
| 5人 | 4台 | 15 | 15 | 15 | 6 |
| 6人 | 5台 | 18 | 18 | 18 | 6 |

## ゲームの流れ

### 1. 準備

1. 人数に応じた宝石を袋に入れる
2. 宝石台を設置
3. 各台に袋から2個ずつ宝石を配置

### 2. ラウンド（アクション選択フェーズ）

各プレイヤーは同時に以下のいずれかを選択:

#### a) 場の宝石台を選ぶ
- 選んだ台の宝石をすべて獲得
- **かぶり**: 同じ台を選んだ人が複数いると、誰も取れない

#### b) 他人の金庫を選ぶ
- 選んだプレイヤーの金庫から宝石をすべて奪う
- **かぶり**: 同じ金庫を複数人が狙うと、誰も奪えない
- **バリア**: 対象がバリアを使用していたら奪えない

#### c) 自分の金庫を選ぶ（バリア）
- 金庫の宝石が「確定」され、奪われなくなる
- **次ラウンドは休み**（アクション選択不可）

### 3. 解決

全員のアクションが確定したら、同時に結果を公開:

1. **場の宝石台**: かぶりがなければ獲得
2. **金庫への攻撃**: かぶりもバリアもなければ奪取成功
3. **バリア**: 金庫の宝石が確定、次ラウンド休み

### 4. 補充

- 空になった台には袋から2個補充
- 宝石が残っている台には1個補充
- 袋が空になったらゲーム終了へ

### 5. ゲーム終了

袋が空になり、次の補充ができなくなったら終了。

**最終得点計算:**
- 金庫の宝石は **確定されていない** ため0点
- 確定済みの宝石のみが得点に

**勝利条件:**
1. 合計得点が高い人
2. 同点なら宝石の総数が多い人

## 戦略ポイント

### 金庫と確定の違い

| 状態 | 意味 |
|------|------|
| 金庫 | 獲得した宝石の一時保管場所。他人に奪われる可能性あり |
| 確定 | バリアで守った宝石。奪われず、ゲーム終了時に得点になる |

### 戦略のジレンマ

- **欲張ると危険**: 金庫に宝石を溜め込むと、狙われやすい
- **バリアのタイミング**: 早すぎると休みで不利、遅いと奪われる
- **かぶり読み**: 美味しい選択肢ほどかぶりやすい

## ゲームフェーズ

| フェーズ | 説明 |
|----------|------|
| waiting | ロビー（プレイヤー募集中） |
| selecting | アクション選択中 |
| revealing | 結果発表（モーダル表示） |
| ended | ゲーム終了（結果画面） |

## UI/UX

### ゲーム画面構成

```
┌─────────────────────────────────────┐
│ [SPARK] R1  袋:36        [退出]    │  ← ヘッダー
├─────────────────────────────────────┤
│                                     │
│  選択中のアクション説明 [確定]      │  ← インフォパネル
│                                     │
├─────────────────────────────────────┤
│  [P1金庫] [P2金庫] [P3金庫]        │  ← プレイヤー上段
├─────────────────────────────────────┤
│                                     │
│    [台1]    [台2]    [台3]         │  ← 宝石台（3D表示）
│                                     │
├─────────────────────────────────────┤
│  [P4金庫] [P5金庫] [P6金庫]        │  ← プレイヤー下段
└─────────────────────────────────────┘
```

### 宝石の3D表示

- React Three Fiber + Rapier物理エンジン使用
- 宝石は八面体（オクタヘドロン）で表現
- 物理シミュレーションでリアルに転がる

### カラースキーム

| 要素 | 色 |
|------|-----|
| 背景 | cyan-900 → blue-900 グラデーション |
| 自分の金庫 | cyan ボーダー |
| 選択中 | amber ハイライト |
| 確定済み | green チェック |
| 休み中 | 薄暗い + ×マーク |

## 技術仕様

### ディレクトリ構造

```
src/games/spark/
├── SparkGame.tsx           # メインコンポーネント
├── components/
│   ├── Lobby.tsx           # ロビー画面
│   ├── GamePlayPhase.tsx   # ゲームプレイ画面
│   ├── RoundResultModal.tsx # ラウンド結果モーダル
│   ├── ResultPhase.tsx     # 最終結果画面
│   ├── Gem.tsx             # 宝石コンポーネント（2D）
│   └── GemPlatform3D.tsx   # 宝石台（3D物理シミュレーション）
├── hooks/
│   └── useRoom.ts          # Firebase部屋管理
├── lib/
│   └── gems.ts             # 宝石・得点計算ロジック
└── types/
    └── game.ts             # TypeScript型定義
```

### 依存パッケージ

```json
{
  "three": "^0.x",
  "@react-three/fiber": "^8.x",
  "@react-three/drei": "^9.x",
  "@react-three/rapier": "^1.x"
}
```

### Firebase構造

```
rooms/
  spark/
    {roomCode}/
      hostId: string
      createdAt: number
      gameState:
        phase: GamePhase
        round: number
        bag: Gem[]
        platforms: Platform[]
        players: Player[]
        winnerId: string | null
        lastRoundResults: RoundResult
```
